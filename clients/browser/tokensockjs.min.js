!function(a){function b(a){return Math.min(a*h,f)}function c(){var a,b="";for(a=0;10>a;a++)b+=i.charAt(Math.random()*i.length|0);return b}function d(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}function e(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}var f=5e3,g=10,h=5,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",j=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}(),k=function(a,b){this._socket=a,this._inTransit={},this._emitter=b};k.prototype.sendMessage=function(a,b){"string"==typeof a&&(a=JSON.parse(a)),a.uuid=c(),this._inTransit[a.rpc]||(this._inTransit[a.rpc]={}),this._inTransit[a.rpc][a.uuid]=b,this._socket.send(JSON.stringify(a))},k.prototype.handleResponse=function(a){var b=null;a.rpc&&a.uuid&&(b=this._inTransit[a.rpc][a.uuid]),b&&"function"==typeof b?(a.error?b(a.error):b(null,a.resp),delete this._inTransit[a.rpc][a.uuid],0===d(this._inTransit[a.rpc])&&delete this._inTransit[a.rpc]):a.channel&&this._emitter.emit("message",a.channel,a.message)};var l=function(a,b,c,d){var e={};a?e.error=a.message||a:e.data=b;var f={rpc:"_rpc",fid:d.fid,resp:e};c._socket.send(JSON.stringify(f))},m=function(a,b,c){if("subscribe"===b)a._channels[c.channel]=!0;else if("unsubscribe"===b)delete a._channels[c.channel];else if("rpc"===b){var d=a._actions;c.command.split(".").forEach(function(a){d=d&&d[a]?d[a]:null}),d&&"function"==typeof d&&d(c.args,function(b,d){l(b,d,a,c)})}},n=function(a){a._connectTimer=setTimeout(function(a){q(a,function(b){b?(a._emitter.emit("reconnect",b),n(a)):a._emitter.emit("reconnect")})},a._connectDelay,a),a._connectDelay=b(a._connectDelay)},o=function(a,b){var c,d=[];for(c in a)if(a.hasOwnProperty(c)&&!("string"==typeof a[c]&&a[c].length<1)){var e=b?b+"["+c+"]":c,f=a[c];d.push("object"==typeof f?o(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return d.join("&")},p=function(b,c,d){if(b=e(b),b.dataType&&"jsonp"===b.dataType.toLowerCase()){var f="token_callback_"+(new Date).getTime()+"_"+Math.round(1e16*Math.random()).toString(36),g=a.document.createElement("script");a[f]=function(b){if(a.document.body.removeChild(g),delete a[f],"string"==typeof b)try{b=JSON.parse(b)}catch(c){return d(new Error(b||"Error making jsonp request!"))}d(b&&b.error?b.error:null,b)},g.onerror=function(b){return a.document.body.removeChild(g),delete a[f],d(new Error("Error making jsonp request!")),!1},g.onload=function(a){return!1},g.src=b.url+(b.url.indexOf("?")>0?"&":"?")+"callback="+f+"&"+o(c||{}),a.document.body.appendChild(g)}else{var h=new a.XMLHttpRequest;b.url+=(c&&b.url.indexOf("?")>0?"&":"?")+o(c||{}),h.open(b.method,b.url,!0),h.onreadystatechange=function(){if(4===h.readyState){var a=h.target?h.target.responseText:h.responseText;try{a=JSON.parse(a)}catch(b){}h.status>=200&&h.status<300?d(null,a):d(a&&a.error?new Error(a.error):a instanceof Error?a:new Error(a||"Error making HTTP request"))}},h.setRequestHeader("Accept","application/json"),h.send()}},q=function(b,c){p(b._opts,b._authentication,function(d,e){return!d&&e&&e.token?(b._token=e.token,b._socket=new a.SockJS(b._apiRoute+b._socketPrefix,null,b._sockjs),b._socket.onopen=function(){b._monitor.sendMessage({rpc:"auth",token:b._token},function(a,d){c="string"==typeof c?b._emitter.emit.bind(b._emitter,c):c,a?c(a):(delete b._closed,clearInterval(b._connectTimer),delete b._connectTimer,b._connectDelay=g,s(b),c())})},b._monitor=new k(b._socket,b._emitter),b._socket.onmessage=function(a){try{a.data=JSON.parse(a.data)}catch(c){return}a.data.internal?m(b,a.data.command,a.data.data):b._monitor.handleResponse(a.data)},void(b._socket.onclose=function(){b._closed=!0,b._reconnect&&n(b)})):(d=d||new Error("No token found!"),"string"==typeof c?b._emitter.emit(c,d):c(d))})},r=function(a,b){a._closed?a._queue.push({fn:b}):b()},s=function(a){for(var b in a._channels)a.subscribe(b);a._queue.forEach(function(a){a.fn&&"function"==typeof a.fn&&a.fn()}),a._queue=[]},t=function(b,c){var d=this;d._emitter=new EventEmitter,j(EventEmitter.prototype).forEach(function(a){d[a]=d._emitter[a]}),d._closed=!0,b||(b={}),d._ready||"function"!=typeof b.ready||d.ready(b.ready),d._onreconnect||"function"!=typeof b.onreconnect||d.onreconnect(b.onreconnect),b.host||(b.host=a.location.host),d._reconnect="undefined"==typeof b.reconnect?!0:b.reconnect,d._channels={},d._ping=b.ping||!1,d._sockjs=b.sockjs||{},d._apiRoute=b.host.indexOf("http")<0?a.location.protocol+"//"+b.host:b.host,d._socketPrefix=b.socketPrefix||"/sockets",d._tokenPath=b.tokenPath||"/socket/token",d._actions="object"==typeof c?c:{},d._authentication=b.authentication||{},d._queue=[],d._connectDelay=g,d._connectTimer=null,d._opts={method:"GET",url:d._apiRoute+d._tokenPath,dataType:b.host!==a.location.host?"jsonp":"json"},d._ping&&d._ping>0&&(d._pingTimer=setInterval(function(){d._closed||d.rpc("_ping",{})},d._ping)),q(d,"ready")};t.prototype.ready=function(a){this._emitter.on("ready",a)},t.prototype.onreconnect=function(a){this._emitter.on("reconnect",a)},t.prototype.channels=function(){return j(this._channels)},t.prototype.rpc=function(a,b,c){var d=this;r(d,function(){d._monitor.sendMessage({rpc:a,req:b},c)})},t.prototype.register=function(a){this._actions=a},t.prototype.subscribe=function(a){var b=this;r(b,function(){b._channels[a]=!0,b._monitor.sendMessage({rpc:"_subscribe",req:{channel:a}})})},t.prototype.unsubscribe=function(a){var b=this;r(b,function(){delete b._channels[a],b._monitor.sendMessage({rpc:"_unsubscribe",req:{channel:a}})})},t.prototype.publish=function(a,b){var c=this;r(c,function(){c._monitor.sendMessage({rpc:"_publish",req:{channel:a,data:b}})})},t.prototype.broadcast=function(a){var b=this;r(b,function(){b._monitor.sendMessage({rpc:"_broadcast",req:{data:a}})})},t.prototype.onmessage=function(a){this._emitter.on("message",a)},t.prototype.end=function(a){this._emitter.removeAllListeners("ready"),this._emitter.removeAllListeners("reconnect"),this._emitter.removeAllListeners("message"),this._closed=!0,this._socket.onclose=a,this._socket.close()},a.TokenSocket=t}("undefined"==typeof window?{}:window),function(){"use strict";function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype,e=this,f=e.EventEmitter;d.getListeners=function(a){var b,c,d=this._getEvents();if(a instanceof RegExp){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if(a instanceof RegExp)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g,h=this.getListenersAsObject(a);for(f in h)if(h.hasOwnProperty(f))for(c=h[f].slice(0),e=c.length;e--;)d=c[e],d.once===!0&&this.removeListener(a,d.listener),g=d.listener.apply(this,b||[]),g===this._getOnceReturnValue()&&this.removeListener(a,d.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return e.EventEmitter=f,a},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:e.EventEmitter=a}.call(this);