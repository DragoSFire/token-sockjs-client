!function(a){var b=5e3,c=10,d=function(a){return Math.min(2*a,b)},e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",f=function(){var a,b="";for(a=0;10>a;a++)b+=e.charAt(Math.random()*e.length|0);return b};Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};var g=function(a,b){this._socket=a,this._inTransit={},this._messageCallback=b||function(){}};g.prototype.sendMessage=function(a,b){"string"==typeof a&&(a=JSON.parse(a)),a.uuid=f(),this._inTransit[a.rpc]||(this._inTransit[a.rpc]={}),this._inTransit[a.rpc][a.uuid]=b,this._socket.send(JSON.stringify(a))},g.prototype.handleResponse=function(a){var b=null;a.rpc&&a.uuid&&(b=this._inTransit[a.rpc][a.uuid]),b&&"function"==typeof b?(a.error?b(a.error):b(null,a.resp),delete this._inTransit[a.rpc][a.uuid],0===Object.size(this._inTransit[a.rpc])&&delete this._inTransit[a.rpc]):this._messageCallback&&this._messageCallback(a.channel,a.message)};var h=function(a,b,c,d){var e={};a?e.error=a.message||a:e.data=b;var f={rpc:"_rpc",fid:d.fid,resp:e};c._socket.send(JSON.stringify(f))},i=function(a,b,c){if("subscribe"===b)a._channels[c.channel]=!0;else if("unsubscribe"===b)delete a._channels[c.channel];else if("rpc"===b){var d=a._actions;c.command.split(".").forEach(function(a){d=d&&d[a]?d[a]:null}),d&&"function"==typeof d&&d(c.args,function(b,d){h(b,d,a,c)})}},j=function(a){a._connectTimer=setTimeout(function(a){m(a,function(b){b?(a._onreconnect(b),j(a)):a._onreconnect()})},a._connectDelay,a),a._connectDelay=d(a._connectDelay)},k=function(a,b){var c,d=[];for(c in a)if(a.hasOwnProperty(c)&&!("string"==typeof a[c]&&a[c].length<1)){var e=b?b+"["+c+"]":c,f=a[c];d.push("object"==typeof f?k(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return d.join("&")},l=function(b,c,d){if(b.dataType&&"jsonp"===b.dataType.toLowerCase()){var e="token_callback_"+(new Date).getTime()+"_"+Math.round(1e16*Math.random()).toString(36),f=a.document.createElement("script");a[e]=function(b){a.document.body.removeChild(f),delete a[e];try{b=JSON.parse(b)}catch(c){return d(new Error(b||"Error making jsonp request!"))}d(b&&b.error?b.error:null,b)},f.onerror=function(){return a.document.body.removeChild(f),delete a[e],d(new Error("Error making jsonp request!")),!1},f.onload=function(){return!1},f.src=b.url+(b.url.indexOf("?")>0?"&":"?")+"callback="+e+"&"+k(c||{}),a.document.body.appendChild(f)}else{var g=new a.XMLHttpRequest;b.url+=(c&&b.url.indexOf("?")>0?"&":"?")+k(c||{}),g.open(b.method,b.url,!0),g.onreadystatechange=function(){if(4===g.readyState){var a=g.target?g.target.responseText:g.responseText;try{a=JSON.parse(a)}catch(b){}g.status>=200&&g.status<300?d(null,a):d(a&&a.error?new Error(a.error):a instanceof Error?a:new Error(a||"Error making HTTP request"))}},g.setRequestHeader("Accept","application/json"),g.send()}},m=function(b,d){l(b._opts,b._authentication,function(e,f){return!e&&f&&f.token?(b._token=f.token,b._socket=new a.SockJS(b._apiRoute+b._socketPrefix,null,b._sockjs),b._socket.onopen=function(){b._monitor.sendMessage({rpc:"auth",token:b._token},function(a){d="string"==typeof d?b[d]:d,a?d(a):(delete b._closed,delete b._connectTimer,b._connectDelay=c,d(),o(b))})},b._monitor=new g(b._socket),b._socket.onmessage=function(a){try{a.data=JSON.parse(a.data)}catch(c){return}a.data.internal?i(b,a.data.command,a.data.data):b._monitor.handleResponse(a.data)},void(b._socket.onclose=function(){b._closed=!0,b._reconnect&&j(b)})):(e=e||new Error("No token found!"),"string"==typeof d?b[d](e):d(e))})},n=function(a,b){a._closed?a._queue.push({fn:b}):b()},o=function(a){for(var b in a._channels)a.subscribe(b);a._queue.forEach(function(a){a.fn&&"function"==typeof a.fn&&a.fn()}),a._queue=[]},p=function(b,d){var e=this;e._closed=!0,b||(b={}),(!e._ready||b.ready)&&(e._ready=b.ready||function(){}),(!e._onreconnect||b.onreconnect)&&(e._onreconnect=b.onreconnect||function(){}),b.host||(b.host=a.location.host),e._reconnect="undefined"==typeof b.reconnect?!0:b.reconnect,e._channels={},e._sockjs=b.sockjs||{},e._apiRoute=b.host.indexOf("http")<0?a.location.protocol+"//"+b.host:b.host,e._socketPrefix=b.socketPrefix||"/sockets",e._tokenPath=b.tokenPath||"/socket/token",e._actions="object"==typeof d?d:{},e._authentication=b.authentication||{},e._queue=[],e._connectDelay=c,e._connectTimer=null,e._opts={type:"GET",url:e._apiRoute+e._tokenPath,dataType:b.host!==a.location.host?"jsonp":"json"},m(e,"_ready")};p.prototype.ready=function(a){this._ready=a},p.prototype.onreconnect=function(a){this._onreconnect=a},p.prototype.channels=function(){return Object.keys(this._channels)},p.prototype.rpc=function(a,b,c){var d=this;n(d,function(){d._monitor.sendMessage({rpc:a,req:b},c)})},p.prototype.register=function(a){this._actions=a},p.prototype.subscribe=function(a){var b=this;n(b,function(){b._channels[a]=!0,b._monitor.sendMessage({rpc:"_subscribe",req:{channel:a}})})},p.prototype.unsubscribe=function(a){var b=this;n(b,function(){delete b._channels[a],b._monitor.sendMessage({rpc:"_unsubscribe",req:{channel:a}})})},p.prototype.publish=function(a,b){var c=this;n(c,function(){c._monitor.sendMessage({rpc:"_publish",req:{channel:a,data:b}})})},p.prototype.broadcast=function(a){var b=this;n(b,function(){b._monitor.sendMessage({rpc:"_broadcast",req:{data:a}})})},p.prototype.onmessage=function(a){this._monitor._messageCallback=a},p.prototype.end=function(a){this._reconnect=!1,this._closed=!0,this._socket.onclose=a,this._socket.close()},a.TokenSocket=p}("undefined"==typeof window?{}:window);