!function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=function(){var a,c="";for(a=0;10>a;a++)c+=b.charAt(Math.random()*b.length|0);return c},d=function(a,b){this._socket=a,this._inTransit={},this._messageCallback=b||function(){}};d.prototype.sendMessage=function(a,b){"string"==typeof a&&(a=JSON.parse(a));var d=c();a.uuid=d,this._inTransit[a.rpc]||(this._inTransit[a.rpc]={}),this._inTransit[a.rpc][d]=b,this._socket.send(JSON.stringify(a))},d.prototype.handleResponse=function(a){var b=null;a.rpc&&a.uuid&&(b=this._inTransit[a.rpc][a.uuid]),b?(a.error?b(a.error):b(null,a.resp),delete this._inTransit[a.rpc][a.uuid]):this._messageCallback&&this._messageCallback(a.channel,a.message)};var e=function(a,b,c,d){var e={};a?e.error=a.message||a:e.data=b;var f={rpc:"_rpc",fid:d.fid,resp:e};c._socket.send(JSON.stringify(f))},f=function(a,b,c){if("subscribe"===b)a._channels[c.channel]=!0;else if("unsubscribe"===b)delete a._channels[c.channel];else if("rpc"===b){var d=a._actions;c.command.split(".").forEach(function(a){d=d&&d[a]?d[a]:null}),d&&"function"==typeof d&&d(c.args,function(b,d){e(b,d,a,c)})}},g=function(a,b){var c=[];for(var d in a)if(a.hasOwnProperty(d)){var e=b?b+"["+d+"]":d,f=object[d];str.push("object"==typeof f?g(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return c.join("&")},h=function(b,c,d){if(b.dataType&&"jsonp"===b.dataType.toLowerCase()){var e="token_callback_"+(new Date).getTime()+"_"+Math.round(1e16*Math.random()).toString(36),f=document.createElement("script");a[e]=function(b){document.body.removeChild(f),delete a[e];try{b=JSON.parse(b)}catch(c){return d(new Error(b||"Error making jsonp request!"))}d(b&&b.error?b.error:null,b)},f.onerror=function(){return document.body.removeChild(f),delete a[e],d(new Error("Error making jsonp request!")),!1},f.onload=function(){return!1},f.src=b.url+(b.url.indexOf("?")>0?"&":"?")+d+"="+e+"&"+g(c||{}),document.body.appendChild(f)}else{var h=new a.XMLHttpRequest;b.url+=(b.url.indexOf("?")>0?"&":"?")+g(c||{}),h.open(b.method,b.url,!0),h.onreadystatechange=function(){if(4===h.readyState){var a=h.target?h.target.responseText:null;try{a=JSON.parse(a)}catch(b){}h.status>=200&&h.status<300?d(null,a):d(a?a:new Error("Error making HTTP request"))}},h.setRequestHeader("Accept","application/json"),h.send()}},i=function(b,c){h(b._opts,b._authentication,function(e,g){return e?c(e):g.token?(b._token=g.token,b._socket=new a.SockJS(b._apiRoute+b._socketPrefix,null,b._sockjs),b._socket.onopen=function(){b._monitor.sendMessage({rpc:"auth",token:b._token},function(a){a?c(a):(delete b._closed,c(),k(b))})},b._monitor=new d(b._socket),b._socket.onmessage=function(a){try{a.data=JSON.parse(a.data)}catch(c){return}a.data.internal?f(b,a.data.command,a.data.data):b._monitor.handleResponse(a.data)},void(b._socket.onclose=function(){b._closed=!0,b._reconnect&&i(b,b._onreconnect)})):c(new Error("No token found!"))})},j=function(a,b){a._closed?a._queue.push({fn:b}):b()},k=function(a){for(var b in a._channels)a.subscribe(b);a._queue.forEach(function(a){a.fn&&"function"==typeof a.fn&&a.fn()}),a._queue=[]},l=function(b,c){var d=this;d._closed=!0,d._ready||(d._ready=function(){}),d._onreconnect||(d._onreconnect=function(){}),b="undefined"==typeof b?{}:b,b.host||(b.host=a.location.host),d._reconnect="undefined"==typeof b.reconnect?!0:b.reconnect,d._channels={},d._sockjs=b.sockjs||{},d._apiRoute=b.host.indexOf("http")<0?a.location.protocol+"//"+b.host:b.host,d._socketPrefix=b.socketPrefix||"/sockets",d._tokenPath=b.tokenPath||"/socket/token",d._actions="object"==typeof c?c:{},d._authentication=b.authentication||{},d._queue=[],d._opts={type:"GET",url:d._apiRoute+d._tokenPath,dataType:b.host!==a.location.host?"jsonp":"json"},i(d,d._ready)};l.prototype.ready=function(a){this._ready=a},l.prototype.onreconnect=function(a){this._onreconnect=a},l.prototype.channels=function(){return Object.keys(this._channels)},l.prototype.rpc=function(a,b,c){var d=this;j(d,function(){d._monitor.sendMessage({rpc:a,req:b},c)})},l.prototype.register=function(a){this._actions=a},l.prototype.subscribe=function(a){var b=this;j(b,function(){b._channels[a]=!0,b._monitor.sendMessage({rpc:"_subscribe",req:{channel:a}})})},l.prototype.unsubscribe=function(a){var b=this;j(b,function(){delete b._channels[a],b._monitor.sendMessage({rpc:"_unsubscribe",req:{channel:a}})})},l.prototype.publish=function(a,b){var c=this;j(c,function(){c._monitor.sendMessage({rpc:"_publish",req:{channel:a,data:b}})})},l.prototype.broadcast=function(a){var b=this;j(b,function(){b._monitor.sendMessage({rpc:"_broadcast",req:{data:a}})})},l.prototype.onmessage=function(a){this._monitor._messageCallback=a},l.prototype.end=function(a){this._reconnect=!1,this._closed=!0,this._socket.onclose=a,this._socket.close()},a.TokenSocket=l}(window);