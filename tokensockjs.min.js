(function(e){if(!window.SockJS){var n=document.createElement("script");n.type="text/javascript";n.src="//cdn.sockjs.org/sockjs-0.3.min.js";e("head").append(n)}var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var o=function(){var e,n="";for(e=0;e<10;e++)n+=t.charAt(Math.random()*t.length|0);return n};var s=function(e,n){this.socket=e;this.inTransit={};this.messageCallback=n||function(){}};s.prototype.sendMessage=function(e,n){if(typeof e==="string")e=JSON.parse(e);var t=o();e.uuid=t;if(!this.inTransit[e.rpc])this.inTransit[e.rpc]={};this.inTransit[e.rpc][t]=n;this.socket.send(JSON.stringify(e))};s.prototype.handleResponse=function(e){var n=null;if(e.rpc&&e.uuid)n=this.inTransit[e.rpc][e.uuid];if(n){if(e.error)n(e.error);else n(null,e.resp);delete this.inTransit[e.rpc][e.uuid]}else if(this.messageCallback){this.messageCallback(e.channel,e.message)}};var r=function(e,n,t){switch(n){case"subscribe":e._channels[t.channel]=true;break;case"unsubscribe":delete e._channels[t.channel];break}};var a=function(n,t,o){var a=this;if(!a._ready)a._ready=function(){};a._channels={};a.apiRoute=window.location.protocol+"//"+(n||window.location.host);a.socketPrefix=o||"/sockets";a.tokenPath=t;var i={type:"GET",url:a.apiRoute+a.tokenPath};if(n!==window.location.host)i.dataType="jsonp";var c=e.ajax(i);c.done(function(e){if(!e.token)return a._ready(new Error("No token found!"));a.token=e.token;a.socket=new SockJS(a.apiRoute+a.socketPrefix);a.socket.onopen=function(){a.monitor.sendMessage({rpc:"auth",token:a.token},function(e,n){if(e)a._ready(e);else a._ready(null,true)})};a.monitor=new s(a.socket);a.socket.onmessage=function(e){e.data=JSON.parse(e.data);if(e.data.internal)r(a,e.data.command,e.data.data);else a.monitor.handleResponse(e.data)}});c.fail(function(e,n,t){a._ready(new Error(t||"Error creating websocket connection!"))})};a.prototype.ready=function(e){this._ready=e};a.prototype.channels=function(){return Object.keys(this._channels)};a.prototype.rpc=function(e,n,t){this.monitor.sendMessage({rpc:e,req:n},t)};a.prototype.subscribe=function(e){this._channels[e]=true;this.monitor.sendMessage({rpc:"_subscribe",req:{channel:e}})};a.prototype.unsubscribe=function(e){delete this._channels[e];this.monitor.sendMessage({rpc:"_unsubscribe",req:{channel:e}})};a.prototype.publish=function(e,n){this.monitor.sendMessage({rpc:"_publish",req:{channel:e,data:n}})};a.prototype.broadcast=function(e){this.monitor.sendMessage({rpc:"_broadcast",req:{data:e}})};a.prototype.onmessage=function(e){this.monitor.messageCallback=e};a.prototype.end=function(e){this.socket.close();this.socket.onclose=e};e.TokenSocket=a})(jQuery);