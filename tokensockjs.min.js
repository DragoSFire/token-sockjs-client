!function(e){if(!window.SockJS){var n=document.createElement("script");n.type="text/javascript",n.src="//cdnjs.cloudflare.com/ajax/libs/sockjs-client/0.3.4/sockjs.min.js",e("head").append(n)}var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=function(){var e,n="";for(e=0;10>e;e++)n+=t.charAt(Math.random()*t.length|0);return n},s=function(e,n){this.socket=e,this.inTransit={},this.messageCallback=n||function(){}};s.prototype.sendMessage=function(e,n){"string"==typeof e&&(e=JSON.parse(e));var t=o();e.uuid=t,this.inTransit[e.rpc]||(this.inTransit[e.rpc]={}),this.inTransit[e.rpc][t]=n,this.socket.send(JSON.stringify(e))},s.prototype.handleResponse=function(e){var n=null;e.rpc&&e.uuid&&(n=this.inTransit[e.rpc][e.uuid]),n?(e.error?n(e.error):n(null,e.resp),delete this.inTransit[e.rpc][e.uuid]):this.messageCallback&&this.messageCallback(e.channel,e.message)};var a=function(e,n,t){switch(n){case"subscribe":e._channels[t.channel]=!0;break;case"unsubscribe":delete e._channels[t.channel]}},r=function(n,t,o){var r=this;r._ready||(r._ready=function(){}),r._channels={},r.apiRoute=window.location.protocol+"//"+(n||window.location.host),r.socketPrefix=o||"/sockets",r.tokenPath=t;var i={type:"GET",url:r.apiRoute+r.tokenPath};n!==window.location.host&&(i.dataType="jsonp");var c=e.ajax(i);c.done(function(e){return e.token?(r.token=e.token,r.socket=new SockJS(r.apiRoute+r.socketPrefix),r.socket.onopen=function(){r.monitor.sendMessage({rpc:"auth",token:r.token},function(e){e?r._ready(e):r._ready(null,!0)})},r.monitor=new s(r.socket),void(r.socket.onmessage=function(e){e.data=JSON.parse(e.data),e.data.internal?a(r,e.data.command,e.data.data):r.monitor.handleResponse(e.data)})):r._ready(new Error("No token found!"))}),c.fail(function(e,n,t){r._ready(new Error(t||"Error creating websocket connection!"))})};r.prototype.ready=function(e){this._ready=e},r.prototype.channels=function(){return Object.keys(this._channels)},r.prototype.rpc=function(e,n,t){this.monitor.sendMessage({rpc:e,req:n},t)},r.prototype.subscribe=function(e){this._channels[e]=!0,this.monitor.sendMessage({rpc:"_subscribe",req:{channel:e}})},r.prototype.unsubscribe=function(e){delete this._channels[e],this.monitor.sendMessage({rpc:"_unsubscribe",req:{channel:e}})},r.prototype.publish=function(e,n){this.monitor.sendMessage({rpc:"_publish",req:{channel:e,data:n}})},r.prototype.broadcast=function(e){this.monitor.sendMessage({rpc:"_broadcast",req:{data:e}})},r.prototype.onmessage=function(e){this.monitor.messageCallback=e},r.prototype.end=function(e){this.socket.close(),this.socket.onclose=e},e.TokenSocket=r}(jQuery);
