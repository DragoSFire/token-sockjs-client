!function(n){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=function(){var n,t="";for(n=0;10>n;n++)t+=e.charAt(Math.random()*e.length|0);return t},o=function(n,e){this._socket=n,this._inTransit={},this._messageCallback=e||function(){}};o.prototype.sendMessage=function(n,e){"string"==typeof n&&(n=JSON.parse(n));var o=t();n.uuid=o,this._inTransit[n.rpc]||(this._inTransit[n.rpc]={}),this._inTransit[n.rpc][o]=e,this._socket.send(JSON.stringify(n))},o.prototype.handleResponse=function(n){var e=null;n.rpc&&n.uuid&&(e=this._inTransit[n.rpc][n.uuid]),e?(n.error?e(n.error):e(null,n.resp),delete this._inTransit[n.rpc][n.uuid]):this._messageCallback&&this._messageCallback(n.channel,n.message)};var s=function(n,e,t,o){var s={};n?s.error=n.message||n:s.data=e;var r={rpc:"_rpc",fid:o.fid,resp:s};t._socket.send(JSON.stringify(r))},r=function(n,e,t){if("subscribe"===e)n._channels[t.channel]=!0;else if("unsubscribe"===e)delete n._channels[t.channel];else if("rpc"===e){var o=n._actions;t.command.split(".").forEach(function(n){o=o&&o[n]?o[n]:null}),o&&"function"==typeof o&&o(t.args,function(e,o){s(e,o,n,t)})}},i=function(e,t,s,i){var a=this;a._ready||(a._ready=function(){}),a._channels={},a._apiRoute=window.location.protocol+"//"+(e||window.location.host),a._socketPrefix=s||"/sockets",a._tokenPath=t,a._actions="object"==typeof i?i:{};var c={type:"GET",url:a._apiRoute+a._tokenPath};e!==window.location.host&&(c.dataType="jsonp");var p=n.ajax(c);p.done(function(n){return n.token?(a._token=n.token,a._socket=new SockJS(a._apiRoute+a._socketPrefix),a._socket.onopen=function(){a._monitor.sendMessage({rpc:"auth",token:a._token},function(n){n?a._ready(n):a._ready()})},a._monitor=new o(a._socket),void(a._socket.onmessage=function(n){n.data=JSON.parse(n.data),n.data.internal?r(a,n.data.command,n.data.data):a._monitor.handleResponse(n.data)})):a._ready(new Error("No token found!"))}),p.fail(function(n,e,t){a._ready(new Error(t||"Error creating websocket connection!"))})};i.prototype.ready=function(n){this._ready=n},i.prototype.channels=function(){return Object.keys(this._channels)},i.prototype.rpc=function(n,e,t){this._monitor.sendMessage({rpc:n,req:e},t)},i.prototype.register=function(n){this._actions=n},i.prototype.subscribe=function(n){this._channels[n]=!0,this._monitor.sendMessage({rpc:"_subscribe",req:{channel:n}})},i.prototype.unsubscribe=function(n){delete this._channels[n],this._monitor.sendMessage({rpc:"_unsubscribe",req:{channel:n}})},i.prototype.publish=function(n,e){this._monitor.sendMessage({rpc:"_publish",req:{channel:n,data:e}})},i.prototype.broadcast=function(n){this._monitor.sendMessage({rpc:"_broadcast",req:{data:n}})},i.prototype.onmessage=function(n){this._monitor._messageCallback=n},i.prototype.end=function(n){this._socket.close(),this._socket.onclose=n},n.TokenSocket=i}(jQuery);